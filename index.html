<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>弹跳小球游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #d2b48c; /* 牛皮纸色背景 */
            cursor: pointer;
        }
        canvas {
            display: block;
        }
        .info {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #8B4513;
            font-family: Arial, sans-serif;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            width: 60px; /* 缩小状态宽度 */
            transition: width 0.3s ease, height 0.3s ease;
            overflow: hidden;
            cursor: pointer;
        }
        .info:hover {
            width: 250px; /* 悬停时展开宽度 */
        }
        .info .rule-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        .info .rule-details {
            display: none;
            margin-top: 5px;
        }
        .info:hover .rule-details {
            display: block;
        }
        .count-display {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #8B4513;
            font-family: Arial, sans-serif;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        .reset-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 215, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            font-size: 32px;
            color: #8B4513;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>
    <div class="count-display">
        小球数量: <span id="ballCount">4</span>
    </div>
    <div class="info">
        <span class="rule-title">规则</span>
        <div class="rule-details">
            <p><i class="fa fa-mouse-pointer mr-2"></i>点击生成小球</p>
            <p><i class="fa fa-random mr-2"></i>碰撞融合（数字相加）</p>
            <p><i class="fa fa-bomb mr-2"></i>5号球爆炸不生成新球</p>
            <p><i class="fa fa-split mr-2"></i>6→6个1，7→6个2，8→6个3</p>
            <p><i class="fa fa-split mr-2"></i>9→6个4，10→8个3</p>
            <p><i class="fa fa-exclamation-triangle mr-2"></i>超200个球会重置</p>
        </div>
    </div>
    <div class="reset-animation" id="resetAnimation">
        小球数量已重置!
    </div>
    <canvas id="gameCanvas"></canvas>

    <script>
        // 获取画布和上下文
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const ballCountElement = document.getElementById('ballCount');
        const resetAnimation = document.getElementById('resetAnimation');
        
        // 设置画布尺寸为窗口大小
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        // 初始化尺寸并监听窗口变化
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // 小球类
        class Ball {
            constructor(x, y, number = 1) {
                // 数字和大小
                this.number = number;
                this.baseRadius = 15;
                this.radius = this.baseRadius * (0.8 + this.number * 0.2);
                
                // 位置
                this.x = x;
                this.y = y;
                
                // 随机速度和方向
                const angle = Math.random() * Math.PI * 2;
                this.baseSpeed = 2 + Math.random() * 3;
                this.vx = Math.cos(angle) * this.baseSpeed;
                this.vy = Math.sin(angle) * this.baseSpeed;
                
                // 随机颜色
                this.color = this.getRandomColor();
                
                // 弹跳效果参数
                this.elasticity = 0.8 + Math.random() * 0.1;
                
                // 动画状态
                this.exploding = false;
                this.explosionProgress = 0;
                this.pulsing = false;
                this.pulseProgress = 0;
                this.isNew = number > 1 ? true : false; // 新生成的分裂球标记
                this.newTimer = this.isNew ? 30 : 0;
            }
            
            // 获取随机颜色
            getRandomColor() {
                const colors = [
                    '#E63946', '#FFB703', '#FB8500', 
                    '#1D3557', '#457B9D', '#A8DADC'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            // 更新小球状态
            update() {
                if (this.exploding) {
                    this.explosionProgress += 0.1;
                    return;
                }
                
                // 处理新生成小球的闪烁效果
                if (this.isNew && this.newTimer > 0) {
                    this.newTimer--;
                } else {
                    this.isNew = false;
                }
                
                // 处理脉冲动画
                if (this.pulsing) {
                    this.pulseProgress += 0.15;
                    if (this.pulseProgress >= 1) {
                        this.pulsing = false;
                        this.pulseProgress = 0;
                    }
                }
                
                // 移动
                this.x += this.vx;
                this.y += this.vy;
                
                // 边界碰撞检测
                if (this.x - this.radius < 0) {
                    this.x = this.radius;
                    this.vx = -this.vx * this.elasticity;
                } else if (this.x + this.radius > canvas.width) {
                    this.x = canvas.width - this.radius;
                    this.vx = -this.vx * this.elasticity;
                }
                
                if (this.y - this.radius < 0) {
                    this.y = this.radius;
                    this.vy = -this.vy * this.elasticity;
                } else if (this.y + this.radius > canvas.height) {
                    this.y = canvas.height - this.radius;
                    this.vy = -this.vy * this.elasticity;
                }
                
                // 轻微阻尼
                this.vx *= 0.998;
                this.vy *= 0.998;
                
                // 速度过低时重置
                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed < 0.3) {
                    const angle = Math.random() * Math.PI * 2;
                    this.vx = Math.cos(angle) * this.baseSpeed;
                    this.vy = Math.sin(angle) * this.baseSpeed;
                    this.pulsing = true;
                }
            }
            
            // 绘制小球
            draw() {
                if (this.exploding) {
                    this.drawExplosion();
                    return;
                }
                
                // 计算当前半径（考虑脉冲效果）
                let currentRadius = this.radius;
                if (this.pulsing) {
                    currentRadius = this.radius * (1 + 0.1 * Math.sin(this.pulseProgress * Math.PI));
                }
                
                // 新生成小球的闪烁效果
                let alpha = 1;
                if (this.isNew) {
                    alpha = 0.7 + Math.sin(this.newTimer * 0.5) * 0.3;
                }
                
                // 绘制小球
                ctx.beginPath();
                ctx.arc(this.x, this.y, currentRadius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.globalAlpha = alpha;
                ctx.fill();
                
                // 绘制高光
                ctx.beginPath();
                ctx.arc(
                    this.x - currentRadius * 0.3, 
                    this.y - currentRadius * 0.3, 
                    currentRadius * 0.2, 
                    0, Math.PI * 2
                );
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.fill();
                
                // 绘制数字
                ctx.fillStyle = 'white';
                ctx.font = 'bold ' + (currentRadius * 0.6) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.number, this.x, this.y);
                
                ctx.globalAlpha = 1;
            }
            
            // 绘制爆炸效果
            drawExplosion() {
                const size = this.radius * (1 + this.explosionProgress);
                const alpha = 1 - this.explosionProgress;
                
                // 爆炸效果
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.5})`;
                ctx.fill();
                
                // 外层光环
                ctx.beginPath();
                ctx.arc(this.x, this.y, size * 1.2, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 165, 0, ${alpha})`;
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            
            // 碰撞检测
            collidesWith(otherBall) {
                if (this.exploding || otherBall.exploding) return false;
                
                const dx = this.x - otherBall.x;
                const dy = this.y - otherBall.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                return distance < this.radius + otherBall.radius;
            }
            
            // 融合处理
            mergeWith(otherBall) {
                // 数字相加
                const newNumber = this.number + otherBall.number;
                
                // 新位置（两个球中间）
                const newX = (this.x + otherBall.x) / 2;
                const newY = (this.y + otherBall.y) / 2;
                
                // 新速度（平均速度）
                const newVx = (this.vx + otherBall.vx) / 2;
                const newVy = (this.vy + otherBall.vy) / 2;
                
                // 应用新属性
                this.number = newNumber;
                this.x = newX;
                this.y = newY;
                this.vx = newVx;
                this.vy = newVy;
                
                // 更新大小
                this.radius = this.baseRadius * (0.8 + this.number * 0.2);
                
                // 融合动画
                this.pulsing = true;
                this.pulseProgress = 0;
                
                // 检查是否需要爆炸（修改为5及以上爆炸）
                if (this.number >= 5) {
                    this.explode();
                }
            }
            
            // 爆炸并根据数字生成对应小球（5号球不生成新球）
            explode() {
                this.exploding = true;
                
                // 爆炸动画完成后生成新小球（5号球不生成）
                setTimeout(() => {
                    let newBallNumber = 0;
                    let newBallCount = 6; // 默认生成6个
                    
                    // 根据数值确定生成的小球数字和数量（5号球不生成）
                    if (this.number === 6) {
                        newBallNumber = 1;
                    } else if (this.number === 7) {
                        newBallNumber = 2;
                    } else if (this.number === 8) {
                        newBallNumber = 3;
                    } else if (this.number === 9) {
                        newBallNumber = 4;
                    } else if (this.number === 10) {
                        newBallNumber = 3;
                        newBallCount = 8; // 10号球生成8个
                    }
                    
                    // 如果需要生成新小球
                    if (newBallNumber > 0) {
                        // 生成距离，确保足够远
                        const radius = this.radius * 2.5; 
                        
                        for (let i = 0; i < newBallCount; i++) {
                            // 均匀分布在圆周上
                            const angle = (i / newBallCount) * Math.PI * 2;
                            // 计算远离爆炸中心的位置
                            const x = this.x + Math.cos(angle) * radius;
                            const y = this.y + Math.sin(angle) * radius;
                            
                            // 创建新小球并添加到数组
                            const newBall = new Ball(x, y, newBallNumber);
                            // 给新小球一个向外的初速度
                            newBall.vx = Math.cos(angle) * (newBall.baseSpeed * 1.8);
                            newBall.vy = Math.sin(angle) * (newBall.baseSpeed * 1.8);
                            balls.push(newBall);
                        }
                    }
                }, 500); // 等待爆炸动画完成
            }
            
            // 检查爆炸是否完成
            isExplosionFinished() {
                return this.explosionProgress >= 1;
            }
        }
        
        // 小球数组
        const balls = [];
        
        // 初始化：在四个角落生成4个4号球
        window.addEventListener('load', () => {
            const padding = 50; // 距离角落的距离
            
            // 左上角
            const ball1 = new Ball(padding, padding, 4);
            // 右上角
            const ball2 = new Ball(canvas.width - padding, padding, 4);
            // 左下角
            const ball3 = new Ball(padding, canvas.height - padding, 4);
            // 右下角
            const ball4 = new Ball(canvas.width - padding, canvas.height - padding, 4);
            
            // 让角落的球向中心移动
            ball1.vx = 1;
            ball1.vy = 1;
            ball2.vx = -1;
            ball2.vy = 1;
            ball3.vx = 1;
            ball3.vy = -1;
            ball4.vx = -1;
            ball4.vy = -1;
            
            balls.push(ball1, ball2, ball3, ball4);
            updateBallCount();
        });
        
        // 更新小球数量显示
        function updateBallCount() {
            ballCountElement.textContent = balls.length;
        }
        
        // 重置小球
        function resetBalls() {
            // 清空数组
            balls.length = 0;
            
            // 在四个角落重新生成4个4号球
            const padding = 50;
            const ball1 = new Ball(padding, padding, 4);
            const ball2 = new Ball(canvas.width - padding, padding, 4);
            const ball3 = new Ball(padding, canvas.height - padding, 4);
            const ball4 = new Ball(canvas.width - padding, canvas.height - padding, 4);
            
            ball1.vx = 1;
            ball1.vy = 1;
            ball2.vx = -1;
            ball2.vy = 1;
            ball3.vx = 1;
            ball3.vy = -1;
            ball4.vx = -1;
            ball4.vy = -1;
            
            balls.push(ball1, ball2, ball3, ball4);
            
            // 显示重置动画
            resetAnimation.style.opacity = 1;
            setTimeout(() => {
                resetAnimation.style.opacity = 0;
            }, 1000);
            
            updateBallCount();
        }
        
        // 鼠标点击生成新小球
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const newBall = new Ball(x, y);
            balls.push(newBall);
            updateBallCount();
        });
        
        // 触摸设备支持
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            const newBall = new Ball(x, y);
            balls.push(newBall);
            updateBallCount();
        }, { passive: false });
        
        // 动画循环
        function animate() {
            // 检查小球数量是否超过200，如果是则重置
            if (balls.length > 200) {
                resetBalls();
            }
            
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 更新和绘制所有小球
            for (let i = balls.length - 1; i >= 0; i--) {
                const ball = balls[i];
                ball.update();
                ball.draw();
                
                // 移除爆炸完成的小球
                if (ball.isExplosionFinished()) {
                    balls.splice(i, 1);
                    updateBallCount();
                    continue;
                }
            }
            
            // 检测小球之间的碰撞和融合
            for (let i = 0; i < balls.length; i++) {
                for (let j = i + 1; j < balls.length; j++) {
                    const ball1 = balls[i];
                    const ball2 = balls[j];
                    
                    if (ball1.collidesWith(ball2)) {
                        ball1.mergeWith(ball2);
                        balls.splice(j, 1);
                        updateBallCount();
                        j--;
                    }
                }
            }
            
            // 持续动画
            requestAnimationFrame(animate);
        }
        
        // 开始动画
        animate();
    </script>
</body>
</html>
    
