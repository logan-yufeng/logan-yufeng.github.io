<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>弹跳小球游戏 - 20+爆炸规则版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #d2b48c;
            cursor: pointer;
        }
        canvas {
            display: block;
        }
        .info {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #8B4513;
            font-family: Arial, sans-serif;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            width: 60px;
            transition: width 0.3s ease;
            overflow: hidden;
            cursor: pointer;
            z-index: 10;
        }
        .info:hover {
            width: 300px;
        }
        .info .rule-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        .info .rule-details {
            display: none;
            margin-top: 5px;
        }
        .info:hover .rule-details {
            display: block;
        }
        .count-display {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #8B4513;
            font-family: Arial, sans-serif;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-weight: bold;
            z-index: 10;
        }
        .reset-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 215, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            font-size: 32px;
            color: #8B4513;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div class="count-display">
        小球数量: <span id="ballCount">4</span>
    </div>
    <div class="info">
        <span class="rule-title">规则</span>
        <div class="rule-details">
            <p><i class="fa fa-mouse-pointer mr-2"></i>点击生成小球</p>
            <p><i class="fa fa-random mr-2"></i>任意小球碰撞即可合成</p>
            <p><i class="fa fa-bomb mr-2"></i>20及以上球会爆炸</p>
            <p><i class="fa fa-ban mr-2"></i>20号爆炸不分裂</p>
            <p><i class="fa fa-split mr-2"></i>21→6个1，22→6个2</p>
            <p><i class="fa fa-split mr-2"></i>23→6个3，24→6个4</p>
            <p><i class="fa fa-split mr-2"></i>25→6个5，25+同25</p>
            <p><i class="fa fa-exclamation-triangle mr-2"></i>超400个球会重置</p>
        </div>
    </div>
    <div class="reset-animation" id="resetAnimation">
        小球数量已重置!
    </div>
    <canvas id="gameCanvas"></canvas>

    <script>
        // 获取画布和上下文
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const ballCountElement = document.getElementById('ballCount');
        const resetAnimation = document.getElementById('resetAnimation');
        
        // 设置画布尺寸为窗口大小
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        // 初始化尺寸并监听窗口变化
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // 小球类 - 20及以上爆炸规则实现
        class Ball {
            constructor(x, y, number = 1) {
                this.id = Date.now() + Math.random(); // 唯一ID
                this.number = number;
                this.baseRadius = 14;
                this.radius = this.baseRadius * (0.8 + Math.min(number, 30) * 0.03);
                
                // 位置
                this.x = x;
                this.y = y;
                
                // 速度
                this.baseSpeed = 1.0 + Math.random() * 1.0;
                this.vx = (Math.random() - 0.5) * 2 * this.baseSpeed;
                this.vy = (Math.random() - 0.5) * 2 * this.baseSpeed;
                
                // 颜色
                this.color = this.getColor();
                
                // 物理属性
                this.elasticity = 0.7;
                this.friction = 0.996;
                
                // 状态
                this.mergedThisFrame = false;
                this.isNew = number > 1 ? true : false;
                this.newTimer = this.isNew ? 20 : 0;
                this.pulse = 0;
                this.pulsing = false;
                
                // 爆炸相关属性
                this.isExploding = false;
                this.explosionProgress = 0;
                this.willExplode = number >= 20; // 20及以上会爆炸
                this.isLargeNumber = number >= 20;
            }
            
            // 颜色选择
            getColor() {
                if (this.number === 20) {
                    return '#FF5733'; // 20号球用特殊红色
                } else if (this.number >= 21 && this.number <= 24) {
                    return '#9D4EDD'; // 21-24用紫色
                } else if (this.number >= 25) {
                    return '#1D3557'; // 25及以上用深蓝色
                }
                
                const colors = [
                    '#E63946', '#FFB703', '#FB8500', 
                    '#457B9D'
                ];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            // 更新逻辑
            update() {
                // 如果正在爆炸，处理爆炸动画
                if (this.isExploding) {
                    this.explosionProgress += 0.15;
                    return; // 爆炸过程中不执行其他更新
                }
                
                // 重置合并标记
                this.mergedThisFrame = false;
                
                // 新球效果
                if (this.isNew && this.newTimer > 0) {
                    this.newTimer--;
                } else {
                    this.isNew = false;
                }
                
                // 脉冲动画
                if (this.pulsing) {
                    this.pulse += 0.15;
                    if (this.pulse >= Math.PI * 2) {
                        this.pulsing = false;
                        this.pulse = 0;
                    }
                }
                
                // 应用摩擦力
                this.vx *= this.friction;
                this.vy *= this.friction;
                
                // 移动
                this.x += this.vx;
                this.y += this.vy;
                
                // 边界碰撞
                if (this.x - this.radius < 0) {
                    this.x = this.radius;
                    this.vx = -this.vx * this.elasticity;
                } else if (this.x + this.radius > canvas.width) {
                    this.x = canvas.width - this.radius;
                    this.vx = -this.vx * this.elasticity;
                }
                
                if (this.y - this.radius < 0) {
                    this.y = this.radius;
                    this.vy = -this.vy * this.elasticity;
                } else if (this.y + this.radius > canvas.height) {
                    this.y = canvas.height - this.radius;
                    this.vy = -this.vy * this.elasticity;
                }
                
                // 速度过慢时给予推动
                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed < 0.25) {
                    const angle = Math.random() * Math.PI * 2;
                    this.vx = Math.cos(angle) * this.baseSpeed * 0.5;
                    this.vy = Math.sin(angle) * this.baseSpeed * 0.5;
                }
                
                // 检查是否需要爆炸（20及以上）
                if (this.number >= 20 && !this.isExploding) {
                    this.startExplosion();
                }
                
                // 更新标记
                this.willExplode = this.number >= 20;
                this.isLargeNumber = this.number >= 20;
            }
            
            // 开始爆炸动画
            startExplosion() {
                this.isExploding = true;
                this.explosionProgress = 0;
            }
            
            // 绘制小球
            draw() {
                // 处理爆炸动画
                if (this.isExploding) {
                    // 爆炸效果：向外扩散的圆环
                    const maxRadius = this.radius * 3;
                    const currentRadius = this.radius + (maxRadius - this.radius) * this.explosionProgress;
                    const alpha = 1 - this.explosionProgress;
                    
                    // 爆炸外环
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, currentRadius, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(255, 165, 0, ${alpha * 0.8})`;
                    ctx.lineWidth = 5;
                    ctx.stroke();
                    
                    // 爆炸内环
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, currentRadius * 0.7, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(255, 69, 0, ${alpha})`;
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    return;
                }
                
                // 计算当前半径
                let currentRadius = this.radius;
                if (this.pulsing) {
                    currentRadius = this.radius * (1 + 0.1 * Math.sin(this.pulse));
                }
                
                // 新球透明度
                const alpha = this.isNew ? 0.8 + Math.sin(this.newTimer * 0.3) * 0.2 : 1;
                
                // 20及以上球添加警告边框（闪烁效果）
                if (this.number >= 20) {
                    const flashRate = this.number >= 25 ? 0.02 : 0.01;
                    const flash = Math.sin(Date.now() * flashRate) > 0 ? 0.8 : 0.4;
                    
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, currentRadius * 1.1, 0, Math.PI * 2);
                    ctx.strokeStyle = this.number === 20 ? 
                                     `rgba(255, 0, 0, ${flash})` : 
                                     `rgba(255, 215, 0, ${flash})`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                // 绘制小球
                ctx.beginPath();
                ctx.arc(this.x, this.y, currentRadius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.globalAlpha = alpha;
                ctx.fill();
                
                // 高光效果
                ctx.beginPath();
                ctx.arc(
                    this.x - currentRadius * 0.3,
                    this.y - currentRadius * 0.3,
                    currentRadius * 0.15,
                    0, Math.PI * 2
                );
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.fill();
                
                // 绘制数字
                ctx.fillStyle = 'white';
                ctx.font = 'bold ' + (currentRadius * 0.6) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.number, this.x, this.y);
                
                ctx.globalAlpha = 1;
            }
            
            // 碰撞检测
            collidesWith(otherBall) {
                // 爆炸中的球不参与碰撞
                if (this.isExploding || otherBall.isExploding) return false;
                if (this.mergedThisFrame || otherBall.mergedThisFrame) return false;
                
                const dx = this.x - otherBall.x;
                const dy = this.y - otherBall.y;
                const distanceSquared = dx * dx + dy * dy;
                const minDistance = this.radius + otherBall.radius - 2;
                
                return distanceSquared < minDistance * minDistance;
            }
            
            // 合并处理
            mergeWith(otherBall) {
                // 爆炸中的球不参与合并
                if (this.isExploding || otherBall.isExploding) return;
                
                this.mergedThisFrame = true;
                otherBall.mergedThisFrame = true;
                
                // 数字相加
                const newNumber = this.number + otherBall.number;
                
                // 新位置计算
                const newX = (this.x + otherBall.x) / 2;
                const newY = (this.y + otherBall.y) / 2;
                
                // 新速度计算
                const newVx = (this.vx + otherBall.vx) / 2;
                const newVy = (this.vy + otherBall.vy) / 2;
                
                // 更新当前球属性
                this.number = newNumber;
                this.x = newX;
                this.y = newY;
                this.vx = newVx;
                this.vy = newVy;
                
                // 更新大小
                this.radius = this.baseRadius * (0.8 + Math.min(newNumber, 30) * 0.03);
                
                // 合并动画
                this.pulsing = true;
                this.pulse = 0;
                this.isNew = true;
                this.newTimer = 30;
                
                // 检查是否需要爆炸
                if (this.number >= 20) {
                    this.willExplode = true;
                }
            }
            
            // 分裂处理 - 按规则分裂
            split() {
                let newBallNumber = 0;
                const newBallCount = 6; // 分裂为6个小球
                
                // 确定分裂后的小球数字
                if (this.number === 21) {
                    newBallNumber = 1;
                } else if (this.number === 22) {
                    newBallNumber = 2;
                } else if (this.number === 23) {
                    newBallNumber = 3;
                } else if (this.number === 24) {
                    newBallNumber = 4;
                } else if (this.number >= 25) {
                    newBallNumber = 5; // 25及以上都分裂为5
                }
                
                // 20号球不分裂，其他按规则分裂
                if (this.number !== 20 && newBallNumber > 0 && balls.length + newBallCount < 400) {
                    const radius = this.radius * 2;
                    
                    for (let i = 0; i < newBallCount; i++) {
                        const angle = (i / newBallCount) * Math.PI * 2;
                        const x = this.x + Math.cos(angle) * radius;
                        const y = this.y + Math.sin(angle) * radius;
                        
                        const newBall = new Ball(x, y, newBallNumber);
                        newBall.vx = Math.cos(angle) * (newBall.baseSpeed * 1.2);
                        newBall.vy = Math.sin(angle) * (newBall.baseSpeed * 1.2);
                        balls.push(newBall);
                    }
                }
            }
        }
        
        // 小球数组
        const balls = [];
        
        // 初始化：生成4个1号球
        window.addEventListener('load', () => {
            const padding = 80;
            
            // 左上角
            const ball1 = new Ball(padding, padding, 19);
            // 右上角
            const ball2 = new Ball(canvas.width - padding, padding, 19);
            // 左下角
            const ball3 = new Ball(padding, canvas.height - padding, 19);
            // 右下角
            const ball4 = new Ball(canvas.width - padding, canvas.height - padding, 19);
            
            // 向中心移动
            ball1.vx = 0.6;
            ball1.vy = 0.6;
            ball2.vx = -0.6;
            ball2.vy = 0.6;
            ball3.vx = 0.6;
            ball3.vy = -0.6;
            ball4.vx = -0.6;
            ball4.vy = -0.6;
            
            balls.push(ball1, ball2, ball3, ball4);
            updateBallCount();
        });
        
        // 更新小球数量显示
        function updateBallCount() {
            ballCountElement.textContent = balls.length;
        }
        
        // 处理爆炸完成的球（移除并执行分裂）
        function processExplodedBalls() {
            for (let i = balls.length - 1; i >= 0; i--) {
                const ball = balls[i];
                if (ball.isExploding && ball.explosionProgress >= 1) {
                    // 执行分裂（20号球不分裂）
                    ball.split();
                    
                    // 移除当前球
                    balls.splice(i, 1);
                    updateBallCount();
                }
            }
        }
        
        // 重置小球
        function resetBalls() {
            balls.length = 0;
            
            // 重新生成初始球
            const padding = 80;
            const ball1 = new Ball(padding, padding, 1);
            const ball2 = new Ball(canvas.width - padding, padding, 1);
            const ball3 = new Ball(padding, canvas.height - padding, 1);
            const ball4 = new Ball(canvas.width - padding, canvas.height - padding, 1);
            
            ball1.vx = 0.6;
            ball1.vy = 0.6;
            ball2.vx = -0.6;
            ball2.vy = 0.6;
            ball3.vx = 0.6;
            ball3.vy = -0.6;
            ball4.vx = -0.6;
            ball4.vy = -0.6;
            
            balls.push(ball1, ball2, ball3, ball4);
            
            // 显示重置动画
            resetAnimation.style.opacity = 1;
            setTimeout(() => {
                resetAnimation.style.opacity = 0;
            }, 1000);
            
            updateBallCount();
        }
        
        // 鼠标点击生成新小球
        canvas.addEventListener('click', (e) => {
            if (balls.length < 350) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const newBall = new Ball(x, y);
                balls.push(newBall);
                updateBallCount();
            }
        });
        
        // 触摸设备支持
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (balls.length < 350) {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                const newBall = new Ball(x, y);
                balls.push(newBall);
                updateBallCount();
            }
        }, { passive: false });
        
        // 动画循环
        function animate() {
            // 检查小球数量是否超过400
            if (balls.length > 400) {
                resetBalls();
            }
            
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 更新所有小球
            for (let i = 0; i < balls.length; i++) {
                balls[i].update();
            }
            
            // 处理爆炸完成的球
            processExplodedBalls();
            
            // 碰撞检测
            const ballsCopy = [...balls];
            for (let i = 0; i < ballsCopy.length; i++) {
                const ball1 = ballsCopy[i];
                // 检查球是否仍然存在且没有在爆炸
                if (!balls.includes(ball1) || ball1.isExploding) continue;
                
                for (let j = i + 1; j < ballsCopy.length; j++) {
                    const ball2 = ballsCopy[j];
                    if (!balls.includes(ball2) || ball2.isExploding) continue;
                    
                    if (ball1.collidesWith(ball2)) {
                        ball1.mergeWith(ball2);
                        const index = balls.indexOf(ball2);
                        if (index !== -1) {
                            balls.splice(index, 1);
                            updateBallCount();
                        }
                    }
                }
            }
            
            // 绘制所有小球
            for (let i = 0; i < balls.length; i++) {
                balls[i].draw();
            }
            
            requestAnimationFrame(animate);
        }
        
        // 开始动画
        animate();
    </script>
</body>
</html>
    
